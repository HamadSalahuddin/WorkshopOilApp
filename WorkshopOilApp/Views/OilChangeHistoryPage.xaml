<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WorkshopOilApp.ViewModels"
             x:Class="WorkshopOilApp.Views.OilChangeHistoryPage"
             Title="Oil Change History"
             BackgroundColor="{AppThemeBinding Light=#F8FAFC, Dark={StaticResource Gray950}}">

    <ContentPage.BindingContext>
        <vm:OilChangeHistoryViewModel />
    </ContentPage.BindingContext>

    <Grid RowDefinitions="Auto,*">
        <!-- Date Range Filter Card -->
        <Frame Grid.Row="0" BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}" Margin="12,10" CornerRadius="16" HasShadow="True">
            <VerticalStackLayout Padding="18" Spacing="15">
                <Label Text="Filter by Date Range" FontSize="18" FontAttributes="Bold" TextColor="{AppThemeBinding Light={StaticResource HeadingColorLight}, Dark={StaticResource HeadingColorDark}}" />

                <Grid ColumnDefinitions="*,*" ColumnSpacing="15">
                    <VerticalStackLayout>
                        <Label Text="From Date" FontSize="14" FontAttributes="Bold" />
                        <DatePicker Date="{Binding StartDate}"
                                    MaximumDate="{Binding Today}"
                                    Format="dd MMM yyyy" />
                    </VerticalStackLayout>

                    <VerticalStackLayout Grid.Column="1">
                        <Label Text="To Date" FontSize="14" FontAttributes="Bold" />
                        <DatePicker Date="{Binding EndDate}"
                                    MaximumDate="{Binding Today}"
                                    MinimumDate="{Binding StartDate}"
                                    Format="dd MMM yyyy" />
                    </VerticalStackLayout>
                </Grid>

                <Button Text="Apply Filter"
                        Command="{Binding ApplyFilterCommand}"
                        BackgroundColor="#3B82F6"
                        TextColor="White"
                        CornerRadius="12"
                        HeightRequest="48" />
            </VerticalStackLayout>
        </Frame>

        <!-- History List with Pull-to-Refresh + Pagination -->
        <!--<RefreshView Grid.Row="1"
                     Command="{Binding RefreshCommand}"
                     IsRefreshing="{Binding IsRefreshing }">-->

        <CollectionView ItemsSource="{Binding History}"
                        Grid.Row="1"
                        RemainingItemsThreshold="5"
                        RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">

            <!-- Add Header to show loading state -->
            <CollectionView.Header>
                <Grid HeightRequest="60" IsVisible="{Binding IsBusy}">
                    <ActivityIndicator IsRunning="True" 
                     Color="#3B82F6"
                     HorizontalOptions="Center"
                     VerticalOptions="Center"/>
                </Grid>
            </CollectionView.Header>

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="vm:OilChangeCardViewModel">
                    <Frame Margin="12,6" CornerRadius="16" BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}" HasShadow="True">
                        <Grid Padding="18" ColumnDefinitions="*,Auto">
                            <VerticalStackLayout Spacing="10">
                                <Label Text="{Binding LubricantName}"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                      TextColor="{AppThemeBinding Light={StaticResource HeadingColorLight}, Dark={StaticResource HeadingColorDark}}" />

                                <Label Text="{Binding DateDisplay}"
                                       FontSize="15"
                                       TextColor="#64748B" />

                                <HorizontalStackLayout Spacing="20">
                                    <Label Text="{Binding MileageDisplay}" />
                                    <Label Text="{Binding CostDisplay}" 
                                            IsVisible="{Binding HasCost}" />
                                </HorizontalStackLayout>

                                <Label Text="{Binding NotesToDisplay}" 
                                       TextColor="#64748B"
                                       FontSize="14"
                                       IsVisible="{Binding HasNotes}" />
                            </VerticalStackLayout>

                            <Frame BackgroundColor="{Binding NextDueColor}"
                                   CornerRadius="20"
                                   Padding="12,8"
                                   HeightRequest="40"
                                   VerticalOptions="Start"
                                   Grid.Column="1">
                                <Label Text="{Binding NextDueDisplay}"
                                       TextColor="White"
                                       FontSize="13"
                                       FontAttributes="Bold" />
                            </Frame>
                        </Grid>
                    </Frame>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.EmptyView>
                <VerticalStackLayout Padding="40" Spacing="20">
                    <Image Source="no_history.png" HeightRequest="120" Opacity="0.6" />
                    <Label Text="No oil changes found" FontSize="20" HorizontalOptions="Center" />
                    <Label Text="Try adjusting the date range" TextColor="#64748B" HorizontalOptions="Center" />
                </VerticalStackLayout>
            </CollectionView.EmptyView>
        </CollectionView>
        <!--</RefreshView>-->
    </Grid>
</ContentPage>