<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:WorkshopOilApp.ViewModels"
             x:Class="WorkshopOilApp.Views.LubricantListPage"
             Title="Oil Lubricants"
             BackgroundColor="{AppThemeBinding Light=#F8FAFC, Dark={StaticResource Gray950}}"
             x:DataType="vm:LubricantListViewModel">

    <ContentPage.BindingContext>
        <vm:LubricantListViewModel />
    </ContentPage.BindingContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Search -->
        <SearchBar Grid.Row="0"
                   Placeholder="Search by name or viscosity..."
                   Text="{Binding SearchText}"
                   TextChanged="OnSearchTextChanged"
                   Margin="12,10" />

        <!-- List -->
        <RefreshView Grid.Row="1"
                     Command="{Binding RefreshCommand}"
                     IsRefreshing="{Binding IsRefreshing}">
            <CollectionView ItemsSource="{Binding Lubricants}"
                            RemainingItemsThreshold="5"
                            RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="vm:LubricantCardViewModel">
                        <Frame Margin="12,6" CornerRadius="16" BackgroundColor="{AppThemeBinding Light={StaticResource White}, Dark={StaticResource Gray900}}" HasShadow="True">
                            <Grid Padding="16" ColumnDefinitions="*,Auto">
                                <VerticalStackLayout Spacing="8">
                                    <Label Text="{Binding Name}"
                                           FontSize="18"
                                           FontAttributes="Bold"
                                          TextColor="{AppThemeBinding Light={StaticResource HeadingColorLight}, Dark={StaticResource HeadingColorDark}}" />
                                    <Label Text="{Binding Viscosity}"
                                           FontSize="16"
                                           TextColor="#64748B" />
                                    <Label Text="{Binding Type}"
                                           FontSize="14"
                                           TextColor="#475569" />
                                    <Label Text="{Binding ApiSpec}"
                                           FontSize="13"
                                           TextColor="#94A3B8"
                                           IsVisible="{Binding HasApiSpec}" />
                                </VerticalStackLayout>

                                <VerticalStackLayout Grid.Column="1" Spacing="20">
                                    <Label Text="Edit"
                                           TextColor="#3B82F6"
                                           FontAttributes="Bold"
                                           VerticalOptions="Center">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:LubricantListViewModel}}, Path=EditLubricantCommand}"
                              CommandParameter="{Binding}" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                    <Label Text="Delete"
                                            TextColor="red"
                                            FontAttributes="Bold"
                                            VerticalOptions="Center">
                                        <Label.GestureRecognizers>
                                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type vm:LubricantListViewModel}}, Path=DeleteLubricantCommand}"
CommandParameter="{Binding}" />
                                        </Label.GestureRecognizers>
                                    </Label>
                                </VerticalStackLayout>
                                
                            </Grid>
                        </Frame>
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                <!-- Add Footer to show loading state -->
                <CollectionView.Footer>
                    <Grid HeightRequest="60" IsVisible="{Binding IsBusy}">
                        <ActivityIndicator IsRunning="True" 
                         Color="#3B82F6"
                         HorizontalOptions="Center"
                         VerticalOptions="Center"/>
                    </Grid>
                </CollectionView.Footer>

                <CollectionView.EmptyView>
                    <VerticalStackLayout Padding="40" Spacing="20">
                        <Image Source="oil_bottle.png" HeightRequest="120" Opacity="0.6" />
                        <Label Text="No lubricants found" FontSize="20" HorizontalOptions="Center" />
                        <Label Text="Tap + to add your first oil" TextColor="#64748B" HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </CollectionView.EmptyView>
            </CollectionView>
        </RefreshView>

        <!-- Floating + Button -->
        <Button Grid.Row="1"
                Text="+"
                FontSize="28"
                FontAttributes="Bold"
                TextColor="White"
                BackgroundColor="#10B981"
                CornerRadius="30"
                WidthRequest="60"
                HeightRequest="60"
                HorizontalOptions="End"
                VerticalOptions="End"
                Margin="20"
                Command="{Binding AddLubricantCommand}">
            <Button.Shadow>
                <Shadow Brush="#10B981" Opacity="0.4" Radius="15" Offset="0,8"/>
            </Button.Shadow>
        </Button>
    </Grid>
</ContentPage>